
name: Build

on:
  pull_request:
  push:
    branches: [main, develop]
    tags: ['*']
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}


jobs:

  build-dev:
    uses: ./.github/workflows/build_template.yaml
    with:
      dir: Dev

  build-prod:
    uses: ./.github/workflows/build_template.yaml
    with:
      dir: Prod

  notify-packages:
  
    if: |
        (github.event_name == 'push' && contains(github.ref, 'refs/tags/') ) 
        || github.event_name == 'release' 
        || github.event_name == 'workflow_dispatch'
    name: Trigger new docker images of the P8 software packages
    runs-on: ubuntu-latest
    needs: [build-prod]
    strategy:
      matrix:
        repo: ['project8/psyllid']
#          repo: ['project8/katydid', 'project8/locust_mc', 'project8/mermithid', 'project8/psyllid']
    steps:
    
      - name: Repository dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: ${{ matrix.repo }}
          event-type: release-event
